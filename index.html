<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å´‡è¯åå…­æœŸæ•´åˆç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Inter:wght@400;600;800&display=swap');
        
        :root {
            --emerald-primary: #10b981;
            --emerald-dark: #059669;
        }

        body {
            font-family: 'Inter', 'Noto Sans TC', 'Microsoft JhengHei', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            margin: 0;
            padding-bottom: 90px;
            -webkit-tap-highlight-color: transparent;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05);
        }

        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(15px);
            display: flex;
            justify-content: space-around;
            padding: 10px 0 calc(env(safe-area-inset-bottom) + 10px);
            box-shadow: 0 -4px 15px rgba(0,0,0,0.04);
            z-index: 1000;
            border-top: 1px solid #f1f5f9;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.7rem;
            font-weight: 700;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            flex: 1;
        }

        .nav-item.active { color: var(--emerald-primary); transform: translateY(-2px); }
        .nav-item svg { width: 22px; height: 22px; margin-bottom: 4px; transition: transform 0.2s; }
        .nav-item.active svg { transform: scale(1.1); }

        .btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            transition: all 0.3s;
            box-shadow: 0 4px 12px -2px rgba(16, 185, 129, 0.3);
        }

        .btn-primary:hover:not(:disabled) { opacity: 0.95; transform: translateY(-1px); box-shadow: 0 6px 15px -3px rgba(16, 185, 129, 0.4); }
        .btn-primary:active:not(:disabled) { transform: translateY(1px); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }

        .role-badge {
            font-size: 0.65rem;
            padding: 2px 8px;
            border-radius: 999px;
            margin-left: 6px;
            font-weight: 800;
            text-transform: uppercase;
        }
        .role-admin { background-color: #fee2e2; color: #ef4444; border: 1px solid #fecaca; }
        .role-teacher { background-color: #f5f3ff; color: #8b5cf6; border: 1px solid #ddd6fe; }
        .role-leader { background-color: #fef3c7; color: #d97706; border: 1px solid #fde68a; }

        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 10px; }
        .dot-signed { background-color: #10b981; box-shadow: 0 0 8px rgba(16, 185, 129, 0.5); } 
        .dot-missing { background-color: #ef4444; box-shadow: 0 0 8px rgba(239, 68, 68, 0.5); } 
        .dot-late { background-color: #f59e0b; box-shadow: 0 0 8px rgba(245, 158, 11, 0.5); } 
        .dot-leave { background-color: #fb923c; } 
        .dot-official { background-color: #3b82f6; }

        .hidden-view { display: none; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        .modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
            z-index: 2000; 
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }
        .modal-content {
            background: white;
            width: 100%;
            max-width: 550px;
            max-height: 90vh;
            border-radius: 24px;
            overflow-y: auto;
            padding: 28px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .resource-preview-iframe {
            width: 100%;
            height: 480px;
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            margin-bottom: 12px;
            background: #f1f5f9;
        }

        .announcement-image-preview {
            width: 100%;
            max-height: 500px;
            object-fit: contain;
            border-radius: 16px;
            margin-bottom: 16px;
            border: 1px solid #f1f5f9;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .quiz-image {
            width: 100%;
            max-height: 350px;
            object-fit: contain;
            border-radius: 12px;
            margin: 16px 0;
            border: 1px solid #e2e8f0;
        }

        /* è‡ªå®šç¾©æ²è»¸ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        
        .bonus-card { border-left: 5px solid #f59e0b; background: #fffcf0; }
        .question-card { border-left: 5px solid #10b981; }

        #diagnostic-info {
            font-family: monospace;
            font-size: 10px;
            color: #94a3b8;
            margin-top: 10px;
            padding: 12px;
            background: #f1f5f9;
            border-radius: 12px;
            display: none;
            line-height: 1.5;
        }
    </style>
</head>
<body>

    <header class="bg-white/80 backdrop-blur-md border-b p-4 flex justify-between items-center sticky top-0 z-50">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-emerald-600 rounded-lg flex items-center justify-center text-white font-bold">å´‡</div>
            <h1 class="text-lg font-black text-slate-800 tracking-tight">åå…­æœŸç®¡ç†ç³»çµ±</h1>
        </div>
        <div id="user-display" class="hidden flex items-center">
            <div class="text-right mr-3">
                <div id="display-name" class="text-xs font-bold text-slate-700">è¼‰å…¥ä¸­...</div>
                <div id="display-role-container"><span id="display-role" class="role-badge"></span></div>
            </div>
            <button onclick="logout()" class="p-2 hover:bg-rose-50 rounded-full transition-colors text-rose-500">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
            </button>
        </div>
    </header>

    <main class="container mx-auto max-w-2xl p-4">
        
        <!-- ç™»å…¥èˆ‡è¨»å†Šæ¨¡çµ„ -->
        <section id="view-login" class="fade-in py-8">
            <div class="glass-card rounded-3xl p-8 border">
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-black text-slate-800">æ­¡è¿å›ä¾†</h2>
                    <p class="text-slate-500 text-sm mt-1">è«‹é¸æ“‡æ‚¨çš„çµ„åˆ¥èˆ‡å§“åç™»å…¥</p>
                </div>
                <div class="space-y-4">
                    <div class="relative">
                        <select id="login-group" class="w-full p-4 pl-12 rounded-2xl bg-slate-50 border border-slate-200 outline-none focus:ring-2 focus:ring-emerald-500 appearance-none font-bold text-slate-700"></select>
                        <div class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                        </div>
                    </div>
                    <div class="relative">
                        <select id="login-name" disabled class="w-full p-4 pl-12 rounded-2xl bg-slate-50 border border-slate-200 outline-none focus:ring-2 focus:ring-emerald-500 appearance-none font-bold text-slate-700"></select>
                        <div class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                        </div>
                    </div>
                    <div class="relative">
                        <input type="password" id="login-pass" class="w-full p-4 pl-12 rounded-2xl bg-slate-50 border border-slate-200 outline-none focus:ring-2 focus:ring-emerald-500 font-bold" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
                        <div class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                        </div>
                    </div>
                    <button onclick="handleLogin()" id="login-btn" class="w-full py-4 btn-primary rounded-2xl font-black text-lg shadow-xl mt-4 active:scale-95">ç™»å…¥ç³»çµ±</button>
                    <div class="text-center mt-6">
                        <button onclick="switchView('register')" class="text-sm text-emerald-600 font-bold hover:underline">åˆæ¬¡ä½¿ç”¨ï¼Ÿè¨»å†Šä¸¦è¨­å®šå¯†ç¢¼</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="view-register" class="hidden-view fade-in py-8">
            <div class="glass-card rounded-3xl p-8 border">
                <h2 class="text-2xl font-black text-slate-800 text-center mb-6">å¸³è™Ÿè¨»å†Š</h2>
                <div class="space-y-4 font-bold">
                    <select id="reg-group" class="w-full p-4 rounded-2xl bg-slate-50 border border-slate-200 outline-none"></select>
                    <select id="reg-name" disabled class="w-full p-4 rounded-2xl bg-slate-50 border border-slate-200 outline-none"></select>
                    <input type="password" id="reg-pass" placeholder="è¨­å®šå¯†ç¢¼" class="w-full p-4 rounded-2xl bg-slate-50 border border-slate-200 outline-none">
                    <input type="password" id="reg-pass-confirm" placeholder="å†æ¬¡ç¢ºèªå¯†ç¢¼" class="w-full p-4 rounded-2xl bg-slate-50 border border-slate-200 outline-none">
                    <button onclick="handleRegister()" id="reg-btn" class="w-full py-4 btn-primary rounded-2xl font-black shadow-lg">æäº¤è¨»å†Š</button>
                    <button onclick="switchView('login')" class="w-full py-2 text-sm text-slate-400 font-bold hover:text-slate-600">è¿”å›ç™»å…¥</button>
                </div>
            </div>
        </section>

        <!-- å…¬å‘Šæ¨¡çµ„ -->
        <section id="view-bulletin" class="hidden-view fade-in py-6">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-2xl font-black text-slate-800">æœ€æ–°å…¬å‘Š</h2>
                    <p class="text-slate-500 text-xs">å³æ™‚ç²å–èª²ç¨‹èˆ‡æ´»å‹•è³‡è¨Š</p>
                </div>
                <button id="add-announcement-btn" onclick="openAnnouncementModal(null)" class="hidden bg-emerald-100 text-emerald-700 px-4 py-2 rounded-full font-bold text-sm hover:bg-emerald-200 transition-all">+ ç™¼å¸ƒå…¬å‘Š</button>
            </div>
            <div id="announcement-list" class="space-y-6">
                <div class="flex flex-col items-center justify-center py-20 text-slate-300">
                    <div class="animate-spin rounded-full h-8 w-8 border-4 border-emerald-500 border-t-transparent mb-4"></div>
                    <p class="font-bold">å…§å®¹åŒæ­¥ä¸­...</p>
                </div>
            </div>
        </section>

        <!-- åœ–å‚³æ¨¡çµ„ -->
        <section id="view-img-transfer" class="hidden-view fade-in py-6">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-2xl font-black text-slate-800">GitHub åœ–å‚³å·¥å…·</h2>
                    <p class="text-slate-500 text-xs">ç©©å®šã€é«˜é€Ÿçš„ CDN åœ–ç‰‡è¨—ç®¡</p>
                </div>
                <button id="configToggle" class="p-3 bg-white rounded-2xl shadow-sm border border-slate-100">
                    <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                </button>
            </div>

            <div id="configPanel" class="hidden glass-card p-6 rounded-2xl border-2 border-emerald-100 mb-6 font-bold space-y-4">
                <h3 class="text-xs font-black text-emerald-600 uppercase tracking-widest">GitHub Repository è¨­å®š</h3>
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label class="block text-[10px] text-slate-400 mb-1 uppercase">Personal Access Token</label>
                        <input type="password" id="inputToken" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-mono" placeholder="github_pat_...">
                    </div>
                    <div>
                        <label class="block text-[10px] text-slate-400 mb-1 uppercase">Repo (User/RepoName)</label>
                        <input type="text" id="inputRepo" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-mono" placeholder="zxc/img-repo">
                    </div>
                </div>
                <button id="saveConfig" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold text-sm shadow-lg">å„²å­˜ä¸¦åŠ å¯†</button>
            </div>

            <div class="glass-card p-6 rounded-3xl border border-white mb-6 text-center">
                <div id="batch-drop-zone" class="border-2 border-dashed border-slate-200 rounded-2xl p-8 hover:border-emerald-500 hover:bg-emerald-50 transition-all cursor-pointer mb-4">
                    <input type="file" id="batchFileInput" class="hidden" accept="image/*" multiple>
                    <div id="batch-file-info" class="space-y-2">
                        <div class="w-12 h-12 bg-emerald-100 rounded-full flex items-center justify-center mx-auto text-emerald-600 mb-2">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        </div>
                        <p class="text-slate-700 font-bold">é¸å–æˆ–æ‹–æ”¾æª”æ¡ˆ</p>
                        <p id="batch-selected-count" class="text-xs text-slate-400">æ”¯æ´å–®æ¬¡å¤šåœ–ä¸Šå‚³</p>
                    </div>
                </div>
                <button id="batchUploadBtn" class="w-full btn-primary font-black py-4 rounded-2xl shadow-xl active:scale-95">é–‹å§‹æ‰¹æ¬¡ä¸Šå‚³</button>
                
                <div id="batch-result-container" class="hidden mt-8 space-y-4 text-left">
                    <div class="flex justify-between items-center border-b pb-2">
                        <h3 class="text-xs font-black text-slate-600 uppercase">æœ¬æ¬¡ä¸Šå‚³ç´€éŒ„</h3>
                        <button onclick="copyAllBatchUrls()" class="text-[10px] text-emerald-600 font-bold bg-emerald-50 px-2 py-1 rounded">å…¨éƒ¨è¤‡è£½</button>
                    </div>
                    <div id="batch-result-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
                </div>
            </div>

            <div class="bg-white rounded-3xl p-6 shadow-sm border border-slate-100">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xs font-black text-slate-400 uppercase tracking-widest">è¿‘æœŸæ­·å²</h2>
                    <button onclick="clearBatchHistory()" class="text-[10px] text-rose-400 font-bold">æ¸…é™¤æ‰€æœ‰ç´€éŒ„</button>
                </div>
                <div id="batch-history-list" class="grid grid-cols-3 sm:grid-cols-4 gap-3"></div>
            </div>
        </section>

        <!-- ç°½åˆ°æ¨¡çµ„ -->
        <section id="view-attendance" class="hidden-view fade-in py-8">
            <div class="glass-card rounded-3xl p-8 text-center border overflow-hidden relative">
                <div class="absolute top-0 left-0 w-full h-1 bg-emerald-500"></div>
                <h2 class="text-2xl font-black mb-4 text-slate-800">æ¯æ—¥é»å</h2>
                
                <!-- ä½ç½®æ¬Šé™å¼•å°è³‡è¨Š -->
                <div id="location-permission-box" class="mb-6 p-5 rounded-2xl bg-amber-50 border border-amber-200 text-amber-900 text-xs font-bold hidden text-left">
                    <div class="flex items-center gap-2 mb-2 font-black text-sm">
                        <svg class="w-5 h-5 text-amber-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>
                        <span>å®šä½æœå‹™æª¢æŸ¥</span>
                    </div>
                    <p id="location-permission-msg" class="mb-3">æ­£åœ¨åµæ¸¬æ‚¨çš„éŠè¦½å™¨æ¬Šé™ç‹€æ…‹...</p>
                    <div id="location-guide" class="space-y-2 text-[11px] text-amber-700 bg-white/50 p-3 rounded-xl hidden">
                        <p><b>iPhone (Safari)ï¼š</b> é»æ“Šç¶²å€åˆ—å·¦å´ã€ŒAAã€æˆ–ã€Œé–é ­ã€â†’ è¨­å®š â†’ ä½ç½® â†’ æ”¹ç‚ºã€Œå…è¨±ã€ã€‚</p>
                        <p><b>Android (Chrome)ï¼š</b> é»æ“Šç¶²å€åˆ—å·¦å´ã€Œé–é ­ã€â†’ æ¬Šé™ â†’ é–‹å•Ÿã€Œä½ç½®è³‡è¨Šã€ã€‚</p>
                    </div>
                    <button onclick="performSignIn()" class="mt-3 w-full py-2 bg-amber-200 hover:bg-amber-300 rounded-lg transition-colors text-amber-900 font-black">é»æ“Šæ­¤è™•å˜—è©¦é‡æ–°è«‹æ±‚æ¬Šé™</button>
                </div>

                <div id="attendance-status" class="py-10 px-6 border-2 border-dashed border-slate-100 rounded-2xl mb-4 text-sm text-slate-400 font-bold leading-relaxed">
                    è¼‰å…¥ä¸­...
                </div>

                <!-- æ’éŒ¯è¨ºæ–·è³‡è¨Š -->
                <div id="diagnostic-info"></div>
                
                <button onclick="performSignIn()" id="signin-btn" class="w-full py-5 btn-primary rounded-2xl text-xl font-black hidden shadow-2xl tracking-widest active:scale-95 mt-4">ç¢ºèªç°½åˆ°</button>
                
                <div id="attendance-signed-msg" class="hidden">
                    <div class="flex items-center justify-center gap-2 text-emerald-600 font-black text-lg">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                        ä»Šæ—¥å·²å®Œæˆç°½åˆ°
                    </div>
                </div>
            </div>
        </section>

        <!-- æ¸¬é©—æ¨¡çµ„ -->
        <section id="view-quiz" class="hidden-view fade-in py-6">
            <div id="quiz-init" class="glass-card rounded-3xl p-8 text-center border">
                <div class="w-16 h-16 bg-emerald-100 rounded-2xl flex items-center justify-center text-emerald-600 mx-auto mb-6">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                </div>
                <h2 class="text-2xl font-black mb-6 text-slate-800">å­¸å“¡æ¸¬é©—</h2>
                <div class="space-y-4">
                    <select id="quiz-type-select" class="w-full p-4 rounded-2xl bg-slate-50 border border-slate-200 outline-none font-bold text-slate-700">
                        <option value="" disabled selected>è«‹é¸æ“‡ç§‘ç›®</option>
                        <option value="è«–èª">è«–èªèª²ç¨‹</option>
                        <option value="æ€§ç†">æ€§ç†é¡Œé‡‹</option>
                        <option value="é“å¾·ç¶“">é“å¾·ç¶“</option>
                        <option value="å…­ç¥–">å…­ç¥–å£‡ç¶“</option>
                    </select>
                    <button onclick="startQuizFlow()" id="start-quiz-btn" class="w-full py-4 btn-primary rounded-2xl font-black text-lg shadow-xl active:scale-95">è¼‰å…¥è€ƒå·</button>
                </div>
            </div>
            <div id="quiz-main" class="mt-4 hidden"><div id="quiz-content" class="space-y-6"></div></div>
        </section>

        <!-- æˆç¸¾æ¨¡çµ„ -->
        <section id="view-results" class="hidden-view fade-in py-6">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-2xl font-black text-slate-800">æ­·å²æˆç¸¾</h2>
                    <p class="text-slate-500 text-xs">å­¸ç¿’æˆæœç´€éŒ„</p>
                </div>
            </div>
            <div id="history-list" class="space-y-4"></div>
        </section>

        <!-- ç®¡ç†ä¸­å¿ƒ -->
        <section id="view-admin" class="hidden-view fade-in py-6">
            <div class="flex items-center gap-3 mb-6">
                <div class="p-2 bg-emerald-600 rounded-xl text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 01-2-2V4a2 2 0 012-2h6a2 2 0 012 2v2M7 19h10m0 0a2 2 0 002-2v-3.586a1 1 0 01.293-.707l3.586-3.586a1 1 0 000-1.414l-3.586-3.586a1 1 0 01-.293-.707V5a2 2 0 00-2-2h-6"></path></svg>
                </div>
                <h2 class="text-2xl font-black text-slate-800">ç®¡ç†å„€è¡¨æ¿</h2>
            </div>
            
            <div id="admin-group-filter-container" class="hidden mb-6 bg-white p-5 rounded-3xl border shadow-sm flex items-center gap-4">
                <span class="text-xs font-black text-slate-400 uppercase whitespace-nowrap">ç¯©é¸</span>
                <select id="admin-group-filter" onchange="applyFilters()" class="w-full p-3 border rounded-xl bg-slate-50 outline-none font-bold text-slate-700 text-sm"></select>
            </div>

            <div id="attendance-report-list" class="space-y-3 mb-10"></div>

            <div id="quiz-config-container" class="bg-slate-900 p-8 rounded-3xl shadow-2xl hidden mb-10 text-center">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-black text-white text-lg">æ¸¬é©—æ™‚æ®µç®¡æ§</h3>
                    <button onclick="quickOpenTwoHours()" class="text-[10px] bg-emerald-500 text-white px-3 py-2 rounded-full font-black uppercase tracking-widest">âš¡ å¿«å•Ÿ 2H</button>
                </div>
                <button id="master-quiz-toggle" onclick="toggleMasterQuizStatus()" class="w-full py-5 rounded-2xl font-black text-white shadow-xl transition-all mb-8 text-xl tracking-tighter bg-slate-700">è¼‰å…¥ä¸­...</button>
                <div class="grid grid-cols-1 gap-4 mb-6 text-left">
                    <div>
                        <label class="text-[10px] font-black text-slate-400 ml-2 uppercase">é–‹å§‹æ™‚é–“</label>
                        <input type="datetime-local" id="unified-quiz-start" class="w-full p-4 border-0 rounded-2xl bg-slate-800 text-white font-bold mt-1 outline-none">
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 ml-2 uppercase">çµæŸæ™‚é–“</label>
                        <input type="datetime-local" id="unified-quiz-end" class="w-full p-4 border-0 rounded-2xl bg-slate-800 text-white font-bold mt-1 outline-none">
                    </div>
                </div>
                <button onclick="saveUnifiedQuizSettings()" id="quiz-save-btn" class="w-full py-4 btn-primary rounded-2xl font-black shadow-lg">æ‰‹å‹•å„²å­˜åŒæ­¥</button>
            </div>
        </section>
    </main>

    <!-- å°è¦½åˆ— -->
    <nav id="main-nav" class="nav-bar hidden">
        <div class="nav-item active" onclick="switchView('bulletin')">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10l4 4v10a2 2 0 01-2 2z"></path></svg>
            <span>é¦–é </span>
        </div>
        <div class="nav-item" onclick="switchView('attendance')">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
            <span>ç°½åˆ°</span>
        </div>
        <div class="nav-item" onclick="switchView('quiz')">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
            <span>æ¸¬é©—</span>
        </div>
        <div class="nav-item" onclick="switchView('results')">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
            <span>æˆç¸¾</span>
        </div>
        <div id="nav-img-transfer" class="nav-item hidden" onclick="switchView('img-transfer')">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
            <span>åœ–å‚³</span>
        </div>
        <div id="nav-admin" class="nav-item hidden" onclick="switchView('admin')">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
            <span>ç®¡ç†</span>
        </div>
    </nav>

    <!-- Modals -->
    <div id="announcement-modal" class="modal" onclick="closeAnnouncementModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 id="ann-modal-title" class="text-xl font-black text-slate-800 border-b pb-4 mb-6">ç·¨è¼¯å…¬å‘Šå…§å®¹</h3>
            <div class="space-y-5 font-bold">
                <input type="hidden" id="ann-id">
                <div>
                    <label class="text-[10px] text-slate-400 uppercase ml-1">å…¬å‘Šæ¨™é¡Œ</label>
                    <input type="text" id="ann-title" placeholder="æ¨™é¡Œ..." class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-emerald-500">
                </div>
                <div>
                    <label class="text-[10px] text-slate-400 uppercase ml-1">ç‹€æ…‹</label>
                    <select id="ann-visible" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none">
                        <option value="Y">ç«‹å³å…¬é–‹</option>
                        <option value="N">æš«æ™‚éš±è—</option>
                    </select>
                </div>
                <div>
                    <label class="text-[10px] text-slate-400 uppercase ml-1">è©³ç´°å…§å®¹</label>
                    <textarea id="ann-content" placeholder="å…§å®¹..." class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl h-40 outline-none focus:ring-2 focus:ring-emerald-500"></textarea>
                </div>
                <div id="ann-resources-container" class="space-y-2"></div>
                <button onclick="addResourceRow()" class="text-xs text-emerald-600 font-bold flex items-center gap-1">+ æ–°å¢é™„ä»¶é€£çµ/é›²ç«¯æª”æ¡ˆ</button>
                <button id="ann-submit-btn" onclick="submitAnnouncement()" class="w-full py-4 btn-primary rounded-2xl font-black mt-4">ç¢ºèªç™¼å¸ƒ</button>
            </div>
        </div>
    </div>

    <div id="detail-modal" class="modal" onclick="closeDetailModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 id="detail-title" class="text-xl font-black mb-6 text-slate-800 border-b pb-4">æ¸¬é©—è©³è§£ç´€éŒ„</h3>
            <div id="detail-body" class="space-y-6"></div>
            <button onclick="closeDetailModal()" class="w-full py-4 mt-8 bg-slate-100 rounded-2xl font-black text-slate-500">é—œé–‰è¦–çª—</button>
        </div>
    </div>

    <div id="proxy-sign-modal" class="modal" onclick="closeProxyModal()">
        <div class="modal-content !max-w-md" onclick="event.stopPropagation()">
            <h3 class="text-xl font-black mb-6 text-slate-800">æ‰‹å‹•èª¿æ•´å‡ºå¸­</h3>
            <div id="proxy-target-display" class="bg-emerald-50 p-4 rounded-2xl text-emerald-700 font-bold mb-6"></div>
            <div class="space-y-4 font-bold">
                <select id="proxy-status-select" class="w-full p-4 bg-slate-50 border rounded-2xl outline-none">
                    <option value="æ­£å¸¸å‡ºå¸­">âœ… æ­£å¸¸å‡ºå¸­</option>
                    <option value="æ™šåˆ°">â³ æ™šåˆ°</option>
                    <option value="å…¬å‡">ğŸ›ï¸ å…¬å‡</option>
                    <option value="äº‹å‡">ğŸ“‹ äº‹å‡</option>
                    <option value="ç—…å‡">ğŸ¥ ç—…å‡</option>
                </select>
                <textarea id="proxy-reason-input" placeholder="åŸå› å‚™è¨» (é¸å¡«)..." class="w-full p-4 bg-slate-50 border rounded-2xl h-24 outline-none focus:ring-2 focus:ring-emerald-500"></textarea>
                <button id="proxy-submit-btn" onclick="submitProxySignIn()" class="w-full py-4 btn-primary rounded-2xl font-black shadow-lg">æ›´æ–°ç´€éŒ„</button>
            </div>
        </div>
    </div>

    <div id="message-box" class="fixed top-5 left-1/2 -translate-x-1/2 p-4 rounded-2xl shadow-2xl text-white z-[3000] font-black pointer-events-none hidden text-sm min-w-[280px] text-center"></div>
    <input type="file" id="global-file-picker" class="hidden" onchange="processFileSelection(event)">

    <script>
        // --- è¨­å®šèˆ‡ç’°å¢ƒè®Šæ•¸ ---
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby1NP6yn-7gSufZayMe-Y0pnaDPJTeTFf8XKRvi4wAiZJyiabesxc2iV58L1Wj3JLY9_Q/exec'; 
        const SPREADSHEET_ID = '1u3D7u5hn7dcVGgGxmNBm233B_sz16kPuUcncvCnNr6U';
        const TEAMS_GID = '1026036029';
        const GROUP_ORDER = ['ç¬¬ä¸€çµ„', 'ç¬¬äºŒçµ„', 'ç¬¬ä¸‰çµ„', 'ç¬¬å››çµ„', 'ç¬¬äº”çµ„', 'ç¬¬å…­çµ„', 'ç¬¬ä¸ƒçµ„','å­ŸåŠ æ‹‰', 'å¾·åœ‹', 'å°å°¼', 'é¦¬ä¾†', 'ç¥å·', 'ä¸»é ˜ç­', 'ç‰¹åŠ©'];
        const QUIZ_GIDS = { 'éš¨å ‚': '0', 'è«–èª': '1250135497', 'æ€§ç†': '1342680959', 'é“å¾·ç¶“': '1246480043', 'å…­ç¥–': '1302889740' };
        const MAX_FILE_SIZE = 20 * 1024 * 1024; 

        // --- å®šä½ç°½åˆ°é…ç½® ---
        const CHECKIN_ZONES = [
            { name: "æ•™å®¤ä¸­å¿ƒ", lat: 24.1338878, lng: 120.7179202, radius: 500 }, 
            { name: "æ³•å£‡å ´åœ°", lat: 24.1059419, lng: 120.5055394, radius: 500 }
        ];

        let currentUser = null, teamsData = {}, historyData = [], cachedAnnouncements = [], cachedSignedUsers = [], proxyTarget = null;
        let currentQuizOpenStatus = false, quizData = [], activeRowForUpload = null;

        // --- æ ¸å¿ƒå·¥å…· ---
        function parseToTaipeiDate(val) { 
            if (!val) return null; 
            const cleanVal = val.toString().replace(/\//g, '-').replace(' ', 'T'); 
            return new Date(cleanVal + (cleanVal.includes('+') ? '' : '+08:00')); 
        }

        function getBatchFormattedDate() { 
            const now = new Date(); 
            const pad = (n) => String(n).padStart(2, '0'); 
            return `${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`; 
        }

        function safeJSONParse(str, fallback = []) { 
            if (!str || str === "undefined" || str === "null") return fallback; 
            try { return JSON.parse(str); } catch (e) { return fallback; } 
        }

        function convertToDirectLink(url) { 
            if (!url) return ""; 
            if (url.includes('drive.google.com/file/d/')) { 
                return `https://drive.google.com/uc?id=${url.split('/d/')[1].split('/')[0]}`; 
            } 
            return url; 
        }

        function convertToEmbedPdfLink(url) { 
            if (url.includes('drive.google.com/file/d/')) { 
                return `https://drive.google.com/file/d/${url.split('/d/')[1].split('/')[0]}/preview`; 
            } 
            return url; 
        }

        function isPdfUrl(url) { return url && (url.toLowerCase().includes('.pdf') || (url.includes('drive.google.com') && url.toLowerCase().includes('pdf'))); }
        function isImageUrl(url) { 
            if (!url) return false; 
            const exts = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp']; 
            return exts.some(e => url.toLowerCase().includes(e)) || (url.includes('drive.google.com') && !url.toLowerCase().includes('pdf')); 
        }

        function toast(m, isErr = false) { 
            const b = document.getElementById('message-box'); 
            if (!b) return; 
            b.innerText = m; 
            b.className = `fixed top-10 left-1/2 -translate-x-1/2 p-4 rounded-2xl shadow-2xl text-white z-[3000] font-black ${isErr?'bg-rose-500':'bg-emerald-600'} pointer-events-none transition-all duration-300 transform scale-100 opacity-100`; 
            b.classList.remove('hidden'); 
            setTimeout(() => { b.classList.add('hidden'); }, 3500); 
        }

        function copyToClipboard(str) { 
            const el = document.createElement('textarea'); 
            el.value = str; 
            document.body.appendChild(el); 
            el.select(); 
            try {
                document.execCommand('copy');
                toast("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿");
            } catch (err) {
                toast("è¤‡è£½å¤±æ•—", true);
            }
            document.body.removeChild(el); 
        }

        // --- åœ°ç†ä½ç½®èˆ‡æ¬Šé™å·¥å…· ---
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; 
            const Ï†1 = lat1 * Math.PI / 180;
            const Ï†2 = lat2 * Math.PI / 180;
            const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
            const Î”Î» = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(Î”Ï† / 2) * Math.sin(Î”Ï† / 2) +
                      Math.cos(Ï†1) * Math.cos(Ï†2) *
                      Math.sin(Î”Î» / 2) * Math.sin(Î”Î» / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; 
        }

        function getCurrentLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) return reject({ code: 0, message: "ç€è¦½å™¨ä¸æ”¯æ´å®šä½" });
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                    enableHighAccuracy: true,
                    timeout: 8000,
                    maximumAge: 0
                });
            });
        }

        async function checkLocationPermission() {
            const box = document.getElementById('location-permission-box');
            const msg = document.getElementById('location-permission-msg');
            const guide = document.getElementById('location-guide');
            
            try {
                if (navigator.permissions && navigator.permissions.query) {
                    const status = await navigator.permissions.query({ name: 'geolocation' });
                    const updateUI = (state) => {
                        if (state === 'denied') {
                            box.classList.remove('hidden');
                            box.classList.add('bg-rose-50', 'text-rose-900', 'border-rose-200');
                            msg.innerHTML = "ğŸš« <b>æ¬Šé™è¢«é˜»æ“‹</b>ï¼šç³»çµ±åµæ¸¬åˆ°æ‚¨ç¦æ­¢äº†å®šä½å­˜å–ã€‚è«‹ä¾ä¸‹æ–¹æ•™å­¸é‡è¨­ã€‚";
                            guide.classList.remove('hidden');
                        } else if (state === 'prompt') {
                            box.classList.remove('hidden');
                            msg.innerText = "ğŸ“ å°šæœªæˆæ¬Šå®šä½ã€‚ç°½åˆ°æ™‚è«‹å‹™å¿…é»æ“Šã€Œå…è¨±ã€ã€‚";
                            guide.classList.add('hidden');
                        } else {
                            box.classList.add('hidden');
                        }
                    };
                    updateUI(status.state);
                    status.onchange = () => updateUI(status.state);
                } else {
                    // Safari ç­‰ä¸æ”¯æ´ query çš„ç’°å¢ƒï¼Œé è¨­é¡¯ç¤ºæç¤ºä½†ä¸å ±éŒ¯
                    box.classList.remove('hidden');
                    msg.innerText = "ğŸ“ è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•ä»¥å˜—è©¦é–‹å•Ÿå®šä½é©—è­‰ã€‚";
                }
            } catch (e) {
                box.classList.remove('hidden');
            }
        }

        // --- è¦–åœ–ç®¡ç† ---
        function switchView(viewName) {
            document.querySelectorAll('section').forEach(v => v.classList.add('hidden-view'));
            const target = document.getElementById(`view-${viewName}`); 
            if (target) target.classList.remove('hidden-view');
            
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            const menuMap = { 'bulletin': 0, 'attendance': 1, 'quiz': 2, 'results': 3, 'img-transfer': 4, 'admin': 5 };
            const navItems = document.querySelectorAll('.nav-item');
            if (navItems[menuMap[viewName]]) navItems[menuMap[viewName]].classList.add('active');

            if(viewName === 'bulletin') loadAnnouncements();
            if(viewName === 'attendance' && currentUser) {
                checkAttendance();
                checkLocationPermission();
            }
            if(viewName === 'results' && currentUser) loadHistoryData();
            if(viewName === 'admin' && currentUser) loadAdminDashboard();
            if(viewName === 'img-transfer') setupImgTransfer();
            window.scrollTo(0,0);
        }

        // --- èº«ä»½é©—è­‰æ¨¡çµ„ ---
        async function fetchTeamsData() { 
            try { 
                const res = await fetch(`https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&gid=${TEAMS_GID}&t=${Date.now()}`);
                const text = await res.text();
                const data = JSON.parse(text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);/)[1]);
                teamsData = {}; 
                data.table.rows.forEach(r => { 
                    const g = r.c[0]?.v, n = r.c[1]?.v; 
                    if(g && n && g!=='çµ„åˆ¥') { 
                        if(!teamsData[g]) teamsData[g] = []; 
                        teamsData[g].push(n); 
                    } 
                }); 
                const groups = Object.keys(teamsData).sort((a,b) => GROUP_ORDER.indexOf(a) - GROUP_ORDER.indexOf(b)); 
                ['login-group', 'reg-group'].forEach(id => { 
                    const s = document.getElementById(id); 
                    if(!s) return; 
                    s.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡çµ„åˆ¥</option>'; 
                    groups.forEach(g => s.add(new Option(g, g))); 
                    s.onchange = (e) => { 
                        const ns = id==='login-group'?document.getElementById('login-name'):document.getElementById('reg-name'); 
                        ns.innerHTML = '<option value="" disabled selected>å§“å</option>'; 
                        (teamsData[e.target.value] || []).sort().forEach(n => ns.add(new Option(n, n))); 
                        ns.disabled = false; 
                    }; 
                }); 
            } catch (e) { console.error("åœ˜éšŠè³‡æ–™è¼‰å…¥å¤±æ•—", e); } 
        }

        async function handleLogin() { 
            const g = document.getElementById('login-group')?.value;
            const n = document.getElementById('login-name')?.value;
            const p = document.getElementById('login-pass')?.value; 
            if(!g || !n || !p) return toast('è«‹è¼¸å…¥å®Œæ•´ç™»å…¥è³‡è¨Š', true); 
            const btn = document.getElementById('login-btn'); 
            btn.disabled = true; 
            try { 
                const res = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'login', group: g, name: n, password: p }) }); 
                const r = await res.json(); 
                if(r.success) { 
                    currentUser = r; 
                    localStorage.setItem('sh_user_secure', JSON.stringify(r)); 
                    initApp(); 
                } else toast(r.error, true); 
            } catch (e) { toast('é€£ç·šç•°å¸¸ï¼Œè«‹ç¨å¾Œå†è©¦', true); } finally { btn.disabled = false; } 
        }

        async function handleRegister() { 
            const g = document.getElementById('reg-group').value;
            const n = document.getElementById('reg-name').value;
            const p = document.getElementById('reg-pass').value;
            const c = document.getElementById('reg-pass-confirm').value; 
            if(p !== c) return toast('å¯†ç¢¼ç¢ºèªä¸ä¸€è‡´', true); 
            if(!p || p.length < 4) return toast('å¯†ç¢¼é•·åº¦éçŸ­', true);
            const btn = document.getElementById('reg-btn'); 
            btn.disabled = true; 
            try { 
                const res = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({action:'register', group:g, name:n, password:p}) }); 
                const result = await res.json();
                if(result.success) { toast('è¨»å†ŠæˆåŠŸï¼Œè«‹ç™»å…¥'); switchView('login'); } 
                else { toast(result.error || 'è¨»å†Šå¤±æ•—', true); }
            } catch(e) { toast('é€£ç·šå¤±æ•—', true); } finally { btn.disabled = false; } 
        }

        // --- å…¬å‘Šæ¨¡çµ„ ---
        async function loadAnnouncements() { 
            try { 
                const res = await fetch(`${APPS_SCRIPT_URL}?action=getAnnouncements`);
                const r = await res.json(); 
                cachedAnnouncements = r.data || []; 
                renderAnnouncements(); 
            } catch (e) {} 
        }

        function renderAnnouncements() {
            const list = document.getElementById('announcement-list'); 
            if(!list) return;
            const isStaff = ['Admin', 'ç®¡ç†å“¡', 'Teacher', 'è€å¸«', 'ç™¼å¸ƒå“¡'].some(r => currentUser?.role.includes(r));
            const filtered = cachedAnnouncements.filter(a => isStaff || a.visible !== 'N');
            
            list.innerHTML = filtered.length ? filtered.map((ann) => {
                let resources = safeJSONParse(ann.link, []);
                const pdfs = resources.filter(r => isPdfUrl(r.url));
                const imgs = resources.filter(r => isImageUrl(r.url));
                const hideTag = (isStaff && ann.visible === 'N') ? '<span class="ml-2 bg-rose-100 text-rose-600 px-2 py-0.5 rounded text-[10px] font-black uppercase">éš±è—ä¸­</span>' : '';
                
                return `<div class="bg-white p-6 rounded-3xl border mb-6 relative group shadow-sm transition-all hover:shadow-md ${ann.visible === 'N' ? 'opacity-70 grayscale-[0.5]' : ''}">
                    ${isStaff ? `<button onclick="openAnnouncementModal(${ann.id})" class="absolute top-4 right-4 text-[10px] bg-slate-100 text-slate-600 font-black px-3 py-1 rounded-full opacity-0 group-hover:opacity-100 transition-all">ç·¨è¼¯å…¬å‘Š</button>` : ''}
                    <div class="text-[10px] font-black text-emerald-600 mb-2 uppercase tracking-widest flex items-center gap-2">
                        <span>${ann.time}</span> ${hideTag}
                    </div>
                    <h3 class="text-xl font-black text-slate-800 mb-3">${ann.title}</h3>
                    <div class="text-sm text-slate-600 leading-relaxed whitespace-pre-wrap mb-6 font-medium">${ann.content}</div>
                    
                    ${imgs.map(img => `<img src="${convertToDirectLink(img.url)}" class="announcement-image-preview" loading="lazy">`).join('')}
                    ${pdfs.map(pdf => `<iframe src="${convertToEmbedPdfLink(pdf.url)}" class="resource-preview-iframe"></iframe>`).join('')}
                    
                    ${resources.length > 0 ? `
                    <div class="pt-6 border-t border-slate-50 flex flex-wrap gap-3">
                        ${resources.map(r => `
                            <a href="${r.url}" target="_blank" class="text-xs bg-slate-50 text-slate-600 px-4 py-3 rounded-2xl font-black flex items-center gap-2 hover:bg-emerald-600 hover:text-white transition-all border border-slate-100">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg>
                                ${r.label}
                            </a>`).join('')}
                    </div>` : ''}
                </div>`;
            }).join('') : '<div class="text-center py-20 text-slate-300 font-bold italic">ç›®å‰æ²’æœ‰æ–°å…¬å‘Š</div>';
        }

        // --- ç°½åˆ°æ¨¡çµ„é‚è¼¯ ---
        async function checkAttendance() { 
            const div = document.getElementById('attendance-status');
            const btn = document.getElementById('signin-btn');
            const msg = document.getElementById('attendance-signed-msg');
            if(!div) return; 
            try { 
                const res = await fetch(`${APPS_SCRIPT_URL}?action=checkAttendance&group=${encodeURIComponent(currentUser.group)}&name=${encodeURIComponent(currentUser.name)}`); 
                const r = await res.json(); 
                if(r.signedIn) {
                    div.innerHTML = `âœ… æ‚¨å·²æ–¼ <b>${r.time}</b> å®Œæˆä»Šæ—¥é»å`;
                    btn.classList.add('hidden');
                    msg.classList.remove('hidden');
                } else {
                    div.innerHTML = `ğŸ‘‹ æ‚¨å¥½ï¼Œç°½åˆ°å‰è«‹å…ˆç¢ºèªæ‰‹æ©Ÿå·²é–‹å•Ÿå®šä½ä¸¦ç«™åœ¨æ­£ç¢ºå€åŸŸã€‚<br><small class="text-slate-400">ç›®å‰è¨­å®šæœ‰ ${CHECKIN_ZONES.length} å€‹åˆæ³•ç°½åˆ°ç¯„åœ</small>`;
                    btn.classList.remove('hidden');
                    msg.classList.add('hidden');
                }
            } catch (e) { console.error("ç°½åˆ°æª¢æŸ¥ç•°å¸¸", e); } 
        }

        async function performSignIn() { 
            const btn = document.getElementById('signin-btn');
            const diag = document.getElementById('diagnostic-info');
            const box = document.getElementById('location-permission-box');
            const msg = document.getElementById('location-permission-msg');
            const guide = document.getElementById('location-guide');
            
            btn.disabled = true;
            toast('æ­£åœ¨è«‹æ±‚å®šä½å­˜å–...');

            try { 
                const pos = await getCurrentLocation();
                const uLat = pos.coords.latitude;
                const uLng = pos.coords.longitude;
                const accuracy = pos.coords.accuracy;

                box.classList.add('hidden'); // ç²å–æˆåŠŸå‰‡éš±è—æ¬Šé™æç¤º
                diag.style.display = 'block';
                diag.innerHTML = `ğŸ“ ç›®å‰å®šä½ï¼š${uLat.toFixed(5)}, ${uLng.toFixed(5)} (èª¤å·®ç´„ ${accuracy.toFixed(0)}m)`;

                let inZone = false;
                let nearestDist = Infinity;
                let zoneName = "";

                CHECKIN_ZONES.forEach(zone => {
                    const dist = getDistance(uLat, uLng, zone.lat, zone.lng);
                    if (dist <= zone.radius) {
                        inZone = true;
                        zoneName = zone.name;
                    }
                    if (dist < nearestDist) nearestDist = dist;
                });

                if (!inZone) {
                    toast(`è·é›¢æœ€è¿‘çš„é»é‚„æœ‰ ${nearestDist.toFixed(0)} å…¬å°ºï¼Œè«‹é è¿‘ä¸€é»ã€‚`, true);
                    diag.innerHTML += `<br>âŒ è·é›¢ã€Œ${CHECKIN_ZONES[0].name}ã€å°šå·® ${nearestDist.toFixed(0)}m (é™ ${CHECKIN_ZONES[0].radius}m)`;
                    btn.disabled = false;
                    return;
                }

                toast(`é©—è­‰æˆåŠŸ (${zoneName})ï¼ŒåŒæ­¥é›²ç«¯ä¸­...`);

                const res = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'signIn', group: currentUser.group, name: currentUser.name }) }); 
                const r = await res.json();
                if (r.success) { 
                    toast(`æ–¼ ${zoneName} ç°½åˆ°æˆåŠŸï¼`); 
                    checkAttendance(); 
                    diag.style.display = 'none';
                } else { 
                    toast(r.error || 'ç°½åˆ°å¤±æ•—', true); 
                    btn.disabled = false; 
                }
            } catch (e) { 
                box.classList.remove('hidden');
                box.classList.add('bg-rose-50', 'text-rose-900', 'border-rose-200');
                guide.classList.remove('hidden');

                let errMsg = "å®šä½å¤±æ•—";
                if (e.code === 1) {
                    errMsg = "æ¬Šé™è¢«æ‹’";
                    msg.innerHTML = "ğŸš« <b>æ¬Šé™è¢«é˜»æ“‹</b>ï¼šæ‚¨å¯èƒ½åœ¨ä¹‹å‰é»æ“Šäº†ã€Œæ‹’çµ•ã€ã€‚è«‹ä¾ä¸‹æ–¹èªªæ˜é‡è¨­ç¶²é å®šä½æ¬Šé™ã€‚";
                } else if (e.code === 2) {
                    errMsg = "å®šä½è¨Šè™Ÿä¸­æ–·";
                    msg.innerHTML = "ğŸ“¡ <b>å®šä½å¤±æ•—</b>ï¼šè«‹ç¢ºèªæ‰‹æ©Ÿæœ¬èº«çš„ã€Œä½ç½®/GPSã€é–‹é—œå·²ç¶“é–‹å•Ÿã€‚";
                } else if (e.code === 3) {
                    errMsg = "å®šä½è¶…æ™‚";
                    msg.innerHTML = "âŒ› <b>å®šä½ç­‰å¾…è¶…æ™‚</b>ï¼šè«‹åˆ°æ”¶è¨Šè‰¯å¥½çš„åœ°æ–¹ï¼ˆçª—æˆ¶æ—ï¼‰é‡è©¦ä¸€æ¬¡ã€‚";
                }
                toast(errMsg, true); 
                btn.disabled = false; 
            } 
        }

        async function loadAdminDashboard() {
            if(!currentUser) return;
            const isAdminOrTeacher = ['Admin', 'ç®¡ç†å“¡', 'Teacher', 'è€å¸«'].some(r => currentUser.role.includes(r));
            const isLeader = ['Leader', 'çµ„é•·'].some(r => currentUser.role.includes(r));
            
            try {
                const res = await fetch(`${APPS_SCRIPT_URL}?action=getAttendanceReport&role=${encodeURIComponent(currentUser.role)}&group=${encodeURIComponent(currentUser.group)}`);
                const result = await res.json(); 
                cachedSignedUsers = result.data || [];
                
                const filterContainer = document.getElementById('admin-group-filter-container');
                const filterSelect = document.getElementById('admin-group-filter');
                
                if (isAdminOrTeacher) {
                    filterContainer.classList.remove('hidden');
                    if(filterSelect.options.length === 0) {
                        filterSelect.innerHTML = '<option value="ALL">ğŸ” æŸ¥çœ‹æ‰€æœ‰çµ„åˆ¥å ±å‘Š</option>';
                        Object.keys(teamsData).sort((a,b)=>GROUP_ORDER.indexOf(a)-GROUP_ORDER.indexOf(b)).forEach(g => filterSelect.add(new Option(g, g)));
                    }
                    document.getElementById('quiz-config-container').classList.remove('hidden');
                } else if (isLeader) {
                    filterContainer.classList.add('hidden');
                    document.getElementById('quiz-config-container').classList.add('hidden');
                }
                
                applyFilters(); 
                loadQuizConfigs();
            } catch (e) { console.error("ç®¡ç†å„€è¡¨æ¿è¼‰å…¥ç•°å¸¸", e); }
        }

        function applyFilters() {
            const list = document.getElementById('attendance-report-list');
            const isLeader = ['Leader', 'çµ„é•·'].some(r => currentUser.role.includes(r));
            const gVal = isLeader ? currentUser.group : (document.getElementById('admin-group-filter')?.value || 'ALL');
            
            let html = ''; 
            const targetGroups = (gVal === 'ALL' ? Object.keys(teamsData).sort((a,b)=>GROUP_ORDER.indexOf(a)-GROUP_ORDER.indexOf(b)) : [gVal]);
            
            targetGroups.forEach(gn => { 
                html += `<div class="text-[10px] font-black text-slate-400 mt-8 px-2 border-l-4 border-emerald-500 ml-1 mb-3 uppercase tracking-widest">${gn}</div>`; 
                (teamsData[gn] || []).forEach(name => { 
                    const sign = cachedSignedUsers.slice().reverse().find(s => s.group === gn && s.name === name); 
                    let dot = 'dot-missing', tCol = 'text-rose-500', txt = 'æœªç°½åˆ°'; 
                    if (sign) { 
                        const n = sign.note || ''; 
                        if (n.includes('æ™šåˆ°')) { dot = 'dot-late'; tCol = 'text-amber-500'; txt = `â³ ${sign.time} (æ™šåˆ°)`; } 
                        else if (n.includes('å…¬å‡')) { dot = 'dot-official'; tCol = 'text-blue-500'; txt = `ğŸ›ï¸ ${n}`; } 
                        else if (n.includes('å‡')) { dot = 'dot-leave'; tCol = 'text-orange-500'; txt = `ğŸ“‹ ${n}`; } 
                        else { dot = 'dot-signed'; tCol = 'text-emerald-600'; txt = `âœ… ${sign.time}`; } 
                    } 
                    html += `
                    <div class="bg-white p-4 rounded-2xl border mb-2 flex justify-between shadow-sm items-center hover:border-emerald-200 transition-all">
                        <div class="flex items-center">
                            <span class="status-dot ${dot}"></span>
                            <span class="font-bold text-slate-700">${name}</span>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="${tCol} text-[11px] font-black tracking-tighter">${txt}</span>
                            <button onclick="openProxyModal('${gn}', '${name}')" class="p-2 text-slate-400 hover:text-emerald-600 transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                            </button>
                        </div>
                    </div>`; 
                }); 
            }); 
            if(list) list.innerHTML = html;
        }

        // --- æ¸¬é©—é–‹é—œç®¡æ§ ---
        async function loadQuizConfigs() { 
            try { 
                const res = await fetch(`${APPS_SCRIPT_URL}?action=getConfig`);
                const config = await res.json();
                
                if (config.gh_token?.start) localStorage.setItem('gh_token', config.gh_token.start);
                if (config.gh_repo?.start) localStorage.setItem('gh_repo', config.gh_repo.start);
                
                const sConf = config['éš¨å ‚'] || { start: '', end: '' };
                const format = (v) => { 
                    if (!v) return ''; 
                    let d = v.toString().trim().replace(/\//g, '-').replace(' ', 'T'); 
                    return d.substring(0, 16); 
                }; 
                
                const sI = document.getElementById('unified-quiz-start'), eI = document.getElementById('unified-quiz-end');
                if(sI) sI.value = format(sConf.start); 
                if(eI) eI.value = format(sConf.end); 
                
                const now = new Date(), st = parseToTaipeiDate(sConf.start), et = parseToTaipeiDate(sConf.end); 
                currentQuizOpenStatus = (st && et && now >= st && now <= et); 
                
                const btn = document.getElementById('master-quiz-toggle'); 
                if(btn) { 
                    btn.innerText = currentQuizOpenStatus ? "ğŸŸ¢ æ¸¬é©—ä¸­ (é»æ“Šé—œé–‰)" : "ğŸ”´ é—œé–‰ä¸­ (é»æ“Šå•Ÿå‹•)"; 
                    btn.className = currentQuizOpenStatus ? "w-full py-5 rounded-2xl font-black text-white shadow-xl transition-all mb-8 text-xl tracking-tighter bg-emerald-600" : "w-full py-5 rounded-2xl font-black text-white shadow-xl transition-all mb-8 text-xl tracking-tighter bg-rose-600"; 
                }
            } catch (e) { console.warn('åŒæ­¥è¨­å®šç•°å¸¸', e); } 
        }

        async function toggleMasterQuizStatus() {
            if (currentQuizOpenStatus) {
                const now = new Date(); 
                const pad = (n) => String(n).padStart(2, '0');
                const pastTime = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}`;
                document.getElementById('unified-quiz-start').value = pastTime.replace(' ', 'T');
                document.getElementById('unified-quiz-end').value = pastTime.replace(' ', 'T');
                toast('æ­£åœ¨é—œé–‰æ¸¬é©—...'); 
                await saveUnifiedQuizSettings(true); 
            } else { 
                quickOpenTwoHours(); 
            }
        }

        async function quickOpenTwoHours() {
            const now = new Date(), end = new Date(now.getTime() + 2 * 60 * 60 * 1000);
            const pad = (n) => String(n).padStart(2, '0');
            const fG = (d) => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
            const s = fG(now), e = fG(end);
            toast('æ­£åœ¨é–‹å•Ÿæ¸¬é©—...');
            try {
                const res = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'updateConfig', config: JSON.stringify({ 'éš¨å ‚':{start:s,end:e},'è«–èª':{start:s,end:e},'æ€§ç†':{start:s,end:e},'é“å¾·ç¶“':{start:s,end:e},'å…­ç¥–':{start:s,end:e} }) }) });
                if((await res.json()).success) { toast('æ¸¬é©—å·²é–‹æ”¾ 2 å°æ™‚'); loadQuizConfigs(); }
            } catch (err) { toast('é€£ç·šå¤±æ•—', true); }
        }

        async function saveUnifiedQuizSettings(silent = false) {
            const s = document.getElementById('unified-quiz-start').value.replace('T', ' ');
            const e = document.getElementById('unified-quiz-end').value.replace('T', ' ');
            if(!s || !e) return toast('è«‹è¼¸å…¥å®Œæ•´æ™‚æ®µ', true);
            try {
                const res = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'updateConfig', config: JSON.stringify({ 'éš¨å ‚':{start:s,end:e},'è«–èª':{start:s,end:e},'æ€§ç†':{start:s,end:e},'é“å¾·ç¶“':{start:s,end:e},'å…­ç¥–':{start:s,end:e} }) }) });
                if((await res.json()).success) { if(!silent) toast('é›²ç«¯è¨­å®šå·²æ›´æ–°'); loadQuizConfigs(); }
            } catch (e) { toast('åŒæ­¥å¤±æ•—', true); }
        }

        // --- æˆç¸¾ç´€éŒ„èˆ‡è©³è§£ ---
        async function loadHistoryData() { 
            const list = document.getElementById('history-list'); if(!list) return;
            try { 
                const res = await fetch(`${APPS_SCRIPT_URL}?action=getHistory&name=${encodeURIComponent(currentUser.name)}&group=${encodeURIComponent(currentUser.group)}`);
                const r = await res.json(); 
                if (r.success && r.data.length) { 
                    historyData = r.data; 
                    list.innerHTML = r.data.map((h, i) => `
                        <div class="bg-white p-6 rounded-3xl border flex justify-between shadow-sm cursor-pointer hover:border-emerald-300 transition-all" onclick="showExamDetail(${i})">
                            <div>
                                <div class="text-[10px] text-slate-400 mb-1 font-black uppercase tracking-widest">${h.timestamp}</div>
                                <div class="font-black text-slate-700">${h.quizType}</div>
                            </div>
                            <div class="text-4xl font-black ${h.score >= 80 ? 'text-emerald-500' : 'text-amber-500'}">${h.score}</div>
                        </div>`).join(''); 
                } else { 
                    list.innerHTML = '<div class="text-center py-20 text-slate-300 font-bold italic">å°šç„¡ä»»ä½•æ¸¬é©—æˆç¸¾</div>'; 
                } 
            } catch (e) {} 
        }

        function showExamDetail(idx) {
            const h = historyData[idx]; if (!h || !h.details) return;
            const title = document.getElementById('detail-title'), body = document.getElementById('detail-body');
            title.innerText = `${h.quizType} - è©³è§£ç´€éŒ„`;
            let details = safeJSONParse(h.details, []);
            body.innerHTML = details.map((d, i) => `
                <div class="p-5 border-2 rounded-2xl mb-2 ${d.isCorrect ? 'bg-emerald-50 border-emerald-100' : 'bg-rose-50 border-rose-100'}">
                    <div class="text-slate-800 font-black mb-2">${i+1}. ${d.question}</div>
                    ${(d.photo && d.photo.includes('http')) ? `<img src="${convertToDirectLink(d.photo)}" class="quiz-image">` : ""}
                    <div class="text-sm mt-3 font-bold">
                        å­¸å“¡å›ç­”ï¼š<span class="${d.isCorrect ? 'text-emerald-600' : 'text-rose-600'}">${d.userAnswer || 'æœªä½œç­”'}</span>
                    </div>
                    ${!d.isCorrect ? `<div class="text-xs text-emerald-600 mt-2 font-black">æ­£ç¢ºè§£ç­”ï¼š${d.correctAnswer}</div>` : ''}
                </div>`).join(''); 
            document.getElementById('detail-modal').style.display = 'flex';
        }

        function closeDetailModal() { document.getElementById('detail-modal').style.display = 'none'; }

        // --- åœ–å‚³åŠŸèƒ½ ---
        function setupImgTransfer() {
            const tI = document.getElementById('inputToken'), rI = document.getElementById('inputRepo');
            tI.value = localStorage.getItem('gh_token') || ''; 
            rI.value = localStorage.getItem('gh_repo') || ''; 
            
            loadBatchHistory();
            
            document.getElementById('configToggle').onclick = () => document.getElementById('configPanel').classList.toggle('hidden');
            document.getElementById('saveConfig').onclick = () => { 
                const t = tI.value.trim(), r = rI.value.trim(); 
                if (!t || !r) return toast("è¨­å®šæ¬„ä½ä¸å¯ç‚ºç©º", true); 
                localStorage.setItem('gh_token', t); 
                localStorage.setItem('gh_repo', r); 
                toast("GitHub è¨­å®šå·²å„²å­˜"); 
                document.getElementById('configPanel').classList.add('hidden'); 
            };
            
            const fi = document.getElementById('batchFileInput'), dz = document.getElementById('batch-drop-zone'), ub = document.getElementById('batchUploadBtn');
            dz.onclick = () => fi.click();
            fi.onchange = (e) => { 
                const c = e.target.files.length; 
                if (c > 0) document.getElementById('batch-selected-count').innerText = `å·²é¸å– ${c} å€‹æª”æ¡ˆ`; 
            };
            
            ub.onclick = async () => {
                const t = localStorage.getItem('gh_token'), r = localStorage.getItem('gh_repo'), files = fi.files;
                if (!t || !r) return toast("è«‹å…ˆå®Œæˆ GitHub è¨­å®š", true); 
                if (files.length === 0) return toast("è«‹é¸å–ç…§ç‰‡æª”æ¡ˆ", true); 
                
                ub.disabled = true; 
                document.getElementById('batch-result-container').classList.remove('hidden'); 
                document.getElementById('batch-result-list').innerHTML = ''; 
                
                for (let i = 0; i < files.length; i++) {
                    const f = files[i]; 
                    ub.innerText = `æ­£åœ¨ä¸Šå‚³ (${i+1}/${files.length})...`;
                    try { 
                        const url = await uploadToGithub(f, t, r); 
                        addBatchResultItem(f.name, url); 
                        saveToBatchHistory(url, f.name); 
                        await saveRecordToSheet(url, f.name);
                    } catch (err) { addBatchResultItem(f.name, null, err.message); }
                }
                ub.disabled = false; ub.innerText = "å®Œæˆæ‰¹æ¬¡ä¸Šå‚³";
            };
        }

        async function uploadToGithub(file, token, repo) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader(); 
                reader.readAsDataURL(file); 
                reader.onload = async () => {
                    const base64 = reader.result.split(',')[1];
                    const date = getBatchFormattedDate();
                    const name = `${date}_${Math.floor(Math.random() * 1000)}.${file.name.split('.').pop()}`;
                    const apiUrl = `https://api.github.com/repos/${repo}/contents/images/${name}`;
                    try {
                        const res = await fetch(apiUrl, { 
                            method: 'PUT', 
                            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, 
                            body: JSON.stringify({ message: `Upload: ${name}`, content: base64, branch: 'main' }) 
                        });
                        if (res.ok) resolve(`https://cdn.jsdelivr.net/gh/${repo}@main/images/${name}`); 
                        else reject(new Error("GitHub èªè­‰å¤±æ•—"));
                    } catch (err) { reject(new Error("é€£ç·šè¶…æ™‚")); }
                };
            });
        }

        function saveToBatchHistory(url, name) { 
            let h = JSON.parse(localStorage.getItem('gh_history_list') || '[]'); 
            h.unshift({ url, name, timestamp: Date.now() }); 
            h = h.slice(0, 20); 
            localStorage.setItem('gh_history_list', JSON.stringify(h)); 
            loadBatchHistory(); 
        }

        function loadBatchHistory() { 
            const list = document.getElementById('batch-history-list'); 
            if(!list) return; 
            let h = JSON.parse(localStorage.getItem('gh_history_list') || '[]'); 
            if (h.length === 0) { list.innerHTML = '<div class="col-span-full py-10 text-slate-300 italic text-[10px] text-center">æš«ç„¡æ­·å²ç´€éŒ„</div>'; return; } 
            list.innerHTML = h.map(item => `
                <div class="relative group aspect-square bg-slate-100 rounded-xl overflow-hidden border border-slate-200">
                    <img src="${item.url}" class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                        <button onclick="copyToClipboard('${item.url}')" class="bg-white text-[9px] font-black px-2 py-1 rounded-lg">è¤‡è£½</button>
                    </div>
                </div>`).join(''); 
        }

        function clearBatchHistory() { if (confirm("ç¢ºå®šæ¸…é™¤æ­·å²å‚³è¼¸ç´€éŒ„ï¼Ÿ")) { localStorage.removeItem('gh_history_list'); loadBatchHistory(); } }

        async function saveRecordToSheet(url, fileName) { 
            try { 
                await fetch(APPS_SCRIPT_URL, { 
                    method: 'POST', 
                    body: JSON.stringify({ action: 'saveTransferRecord', group: currentUser?.group || 'ç®¡ç†å“¡', name: currentUser?.name || 'ç®¡ç†å“¡', fileName: fileName, url: url }) 
                }); 
            } catch (e) {} 
        }

        function addBatchResultItem(name, url, error = null) { 
            const list = document.getElementById('batch-result-list'); 
            const div = document.createElement('div'); 
            div.className = "flex items-center justify-between p-3 bg-slate-50 border rounded-xl animate-in fade-in slide-in-from-top-2"; 
            if (error) { 
                div.innerHTML = `<span class="truncate font-bold text-rose-500">${name}: ä¸Šå‚³å¤±æ•—</span>`; 
            } else { 
                div.innerHTML = `
                <div class="flex items-center gap-3 w-1/2">
                    <img src="${url}" class="w-6 h-6 rounded-md object-cover border">
                    <span class="truncate font-bold text-xs text-slate-700">${name}</span>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="copyToClipboard('${url}')" class="text-[10px] text-emerald-600 font-black">è¤‡è£½ç¶²å€</button>
                </div>`; 
            } 
            list.appendChild(div); 
        }

        // --- å…¬å‘Šç®¡ç† ---
        function openAnnouncementModal(id) { 
            const d = id ? cachedAnnouncements.find(a => a.id == id) : null; 
            document.getElementById('announcement-modal').style.display = 'flex'; 
            document.getElementById('ann-modal-title').innerText = d ? "ç·¨è¼¯å…¬å‘Šå…§å®¹" : "ç™¼å¸ƒæ–°å…¬å‘Š"; 
            document.getElementById('ann-id').value = d ? d.id : ""; 
            document.getElementById('ann-title').value = d ? d.title : ""; 
            document.getElementById('ann-content').value = d ? d.content : ""; 
            document.getElementById('ann-visible').value = d ? d.visible : "Y"; 
            const container = document.getElementById('ann-resources-container'); 
            container.innerHTML = ''; 
            if (d) { 
                let rData = safeJSONParse(d.link, []); 
                rData.forEach(r => addResourceRow(r.label, r.url)); 
            } else { 
                addResourceRow('', ''); 
            } 
        }

        function closeAnnouncementModal() { document.getElementById('announcement-modal').style.display = 'none'; }

        async function submitAnnouncement() { 
            const resData = []; 
            document.querySelectorAll('.resource-row').forEach(row => { 
                const l = row.querySelector('.res-label').value.trim(), u = row.querySelector('.res-url').value.trim(); 
                if(l && u) resData.push({label: l, url: u}); 
            }); 
            const btn = document.getElementById('ann-submit-btn');
            btn.disabled = true;
            try { 
                const res = await fetch(APPS_SCRIPT_URL, { 
                    method: 'POST', 
                    body: JSON.stringify({ 
                        action: 'updateAnnouncement', 
                        id: document.getElementById('ann-id').value, 
                        title: document.getElementById('ann-title').value, 
                        content: document.getElementById('ann-content').value, 
                        link: JSON.stringify(resData), 
                        visible: document.getElementById('ann-visible').value 
                    }) 
                }); 
                const result = await res.json();
                if(result.success) { toast('å®Œæˆæ›´æ–°'); closeAnnouncementModal(); loadAnnouncements(); } 
                else toast('æ›´æ–°å¤±æ•—', true);
            } catch (e) { toast('é€£ç·šå¤±æ•—', true); } finally { btn.disabled = false; }
        }

        function addResourceRow(l='', u='') { 
            const div = document.createElement('div'); 
            div.className = "flex gap-2 mb-2 resource-row animate-in fade-in"; 
            div.innerHTML = `
                <input type="text" placeholder="é¡¯ç¤ºåç¨±" class="res-label flex-1 p-2 text-xs border rounded-lg outline-none" value="${l}">
                <input type="text" placeholder="ç¶²å€" class="res-url flex-[2] p-2 text-xs border rounded-lg bg-slate-50 outline-none" value="${u}">
                <button onclick="triggerFileUpload(this)" class="text-emerald-600 p-2 bg-slate-50 rounded-lg">â˜ï¸</button>
                <button onclick="this.parentElement.remove()" class="text-rose-400 p-2">âœ•</button>`; 
            document.getElementById('ann-resources-container').appendChild(div); 
        }

        function triggerFileUpload(btn) { activeRowForUpload = btn.parentElement; document.getElementById('global-file-picker').click(); }

        async function processFileSelection(event) { 
            const file = event.target.files[0]; 
            if (!file || !activeRowForUpload) return;
            if (file.size > MAX_FILE_SIZE) { toast('æª”æ¡ˆä¸å¯è¶…é 20MB', true); event.target.value = ''; return; }
            toast(`æ­£åœ¨ä¸Šå‚³ï¼š${file.name}...`);
            const reader = new FileReader(); 
            reader.onload = async function(e) {
                try {
                    const res = await fetch(APPS_SCRIPT_URL, { 
                        method: 'POST', 
                        body: JSON.stringify({ action: 'uploadFile', fileName: file.name, mimeType: file.type, base64Data: e.target.result.split(',')[1] }) 
                    });
                    const result = await res.json();
                    if (result.success) { 
                        activeRowForUpload.querySelector('.res-label').value = file.name; 
                        activeRowForUpload.querySelector('.res-url').value = result.url; 
                        toast('ä¸Šå‚³å®Œæˆ'); 
                    } else toast('ä¸Šå‚³å¤±æ•—', true);
                } catch (err) { toast('é™„ä»¶ä¸Šå‚³éŒ¯èª¤', true); }
            };
            reader.readAsDataURL(file); event.target.value = '';
        }

        // --- é»åèª¿æ•´ ---
        function openProxyModal(g, n) { 
            proxyTarget = { group: g, name: n }; 
            document.getElementById('proxy-target-display').innerText = `${g} - ${n}`; 
            document.getElementById('proxy-sign-modal').style.display = "flex"; 
        }
        function closeProxyModal() { document.getElementById('proxy-sign-modal').style.display = "none"; }
        async function submitProxySignIn() { 
            const btn = document.getElementById('proxy-submit-btn'); 
            btn.disabled = true; 
            try { 
                const res = await fetch(APPS_SCRIPT_URL, { 
                    method: 'POST', 
                    body: JSON.stringify({ 
                        action: 'signIn', 
                        group: proxyTarget.group, 
                        name: proxyTarget.name, 
                        leaveType: document.getElementById('proxy-status-select').value, 
                        reason: document.getElementById('proxy-reason-input').value 
                    }) 
                }); 
                if ((await res.json()).success) { toast('å·²æ›´æ–°å‡ºå¸­è¨˜éŒ„'); closeProxyModal(); loadAdminDashboard(); } 
                else toast('æ›´æ–°å¤±æ•—', true);
            } catch (e) { toast('é€£ç·šå¤±æ•—', true); } finally { btn.disabled = false; } 
        }

        // --- æ¸¬é©—åŠŸèƒ½ ---
        async function startQuizFlow() { 
            const type = document.getElementById('quiz-type-select')?.value; 
            if (!type) return toast('è«‹é¸æ“‡ç§‘ç›®', true); 
            const btn = document.getElementById('start-quiz-btn'); 
            btn.disabled = true; 
            try { 
                const resConfig = await fetch(`${APPS_SCRIPT_URL}?action=getConfig`);
                const config = await resConfig.json();
                const quizConf = config['éš¨å ‚'] || config[type];
                const now = new Date(); 
                
                if (quizConf?.start && quizConf?.end) { 
                    const st = parseToTaipeiDate(quizConf.start), et = parseToTaipeiDate(quizConf.end); 
                    if (now < st || now > et) { toast(`æ¸¬é©—å°šæœªé–‹æ”¾`, true); btn.disabled = false; return; } 
                } 
                document.getElementById('quiz-init').classList.add('hidden'); 
                document.getElementById('quiz-main').classList.remove('hidden'); 
                
                const [q1, q2] = await Promise.all([fetchSingleSheet(QUIZ_GIDS['éš¨å ‚']), fetchSingleSheet(QUIZ_GIDS[type])]); 
                quizData = [...q1, ...q2]; 
                renderQuiz(); 
            } catch (e) { toast('è¼‰å…¥å¤±æ•—', true); btn.disabled = false; } 
        }

        function renderQuiz() { 
            const content = document.getElementById('quiz-content'); 
            if(!content) return; 
            let h = `<div class="bg-emerald-50 p-4 rounded-2xl mb-6 text-emerald-800 text-xs font-black text-center border border-emerald-100 uppercase tracking-widest">æ¸¬é©—æ­£å¼é–‹å§‹</div>`; 
            quizData.forEach((q, i) => { 
                const qId = `q${i + 1}`; 
                let imgHtml = (q.photo && q.photo.includes('http')) ? `<img src="${convertToDirectLink(q.photo)}" class="quiz-image">` : ""; 
                let opts = q.isBonus || q.type === 'fill' ? `
                    <input type="text" class="w-full p-4 bg-slate-50 border rounded-2xl outline-none focus:ring-2 focus:ring-emerald-500 font-bold" id="${qId}-input" placeholder="è«‹å›ç­”...">
                ` : [...q.options].sort(()=>Math.random()-0.5).map(o => `
                    <label class="hover:bg-slate-50 border p-4 rounded-2xl flex items-center mb-2 cursor-pointer transition-all border-slate-100 group">
                        <input type="${q.type === 'single' ? 'radio' : 'checkbox'}" name="${qId}" value="${o}" class="mr-4 w-6 h-6 text-emerald-600 border-slate-300">
                        <span class="font-bold text-slate-700">${o}</span>
                    </label>`).join(''); 
                h += `
                <div class="${q.isBonus ? 'bonus-card' : 'question-card'} p-6 rounded-3xl shadow-sm mb-6 bg-white border animate-in fade-in slide-in-from-bottom-2">
                    <div class="text-[10px] font-black text-slate-400 mb-2">ç¬¬ ${i + 1} é¡Œ</div>
                    <h3 class="font-black text-lg mb-2 text-slate-800">${q.question}</h3>
                    ${imgHtml}
                    <div class="mt-4">${opts}</div>
                </div>`; 
            }); 
            h += `<button onclick="handleQuizSubmit()" id="quiz-final-btn" class="w-full py-5 btn-primary rounded-3xl font-black text-xl shadow-2xl mt-10 tracking-widest active:scale-95">æäº¤ç­”æ¡ˆå·</button>`; 
            content.innerHTML = h; 
            window.scrollTo(0,0); 
        }

        async function handleQuizSubmit() { 
            const btn = document.getElementById('quiz-final-btn'); 
            btn.disabled = true; 
            const answers = quizData.map((q, i) => { 
                let val = 'æœªä½œç­”'; 
                if(q.isBonus || q.type === 'fill') val = document.getElementById(`q${i + 1}-input`)?.value.trim() || 'æœªä½œç­”'; 
                else if(q.type === 'single') val = document.querySelector(`input[name="q${i + 1}"]:checked`)?.value || 'æœªä½œç­”'; 
                else val = Array.from(document.querySelectorAll(`input[name="q${i + 1}"]:checked`)).map(i => i.value).sort().join(', '); 
                return { userAnswer: val, isBonus: q.isBonus, photo: q.photo, question: q.question }; 
            }); 
            try { 
                const res = await fetch(APPS_SCRIPT_URL, { 
                    method: 'POST', 
                    body: JSON.stringify({ 
                        action: 'submitQuiz', 
                        group: currentUser.group, 
                        name: currentUser.name, 
                        quizType: document.getElementById('quiz-type-select').value, 
                        userAnswersJson: JSON.stringify(answers), 
                        quizDataJson: JSON.stringify(quizData) 
                    }) 
                }); 
                const result = await res.json();
                if (result.status === 'success') { toast('æäº¤æˆåŠŸï¼'); switchView('results'); } 
                else toast('ç™¼é€å¤±æ•—', true);
            } catch (e) { toast('ç¶²è·¯è¶…æ™‚', true); btn.disabled = false; } 
        }

        async function fetchSingleSheet(gid) { 
            try { 
                const res = await fetch(`https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&gid=${gid}`); 
                const text = await res.text();
                const data = JSON.parse(text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);/)[1]); 
                return data.table.rows.map(r => { 
                    if (!r.c[0]?.v) return null; 
                    return { 
                        question: r.c[0]?.v, 
                        type: r.c[1]?.v?.toLowerCase().trim() || 'single', 
                        options: r.c[2]?.v ? String(r.c[2].v).split(',').map(s=>s.trim()) : [], 
                        answer: String(r.c[3]?.v||'').split(',').map(s=>s.trim()), 
                        score: parseFloat(r.c[4]?.v||0), 
                        photo: r.c[5]?.v || '', 
                        isBonus: r.c[6]?.v === 'æ˜¯' || r.c[6]?.v === 'Yes' 
                    }; 
                }).filter(q => q !== null); 
            } catch(e) { return []; } 
        }

        // --- åˆå§‹åŒ– ---
        function initApp() {
            fetchTeamsData(); 
            loadQuizConfigs();
            const saved = localStorage.getItem('sh_user_secure');
            if(saved && saved !== "undefined") {
                try {
                    currentUser = JSON.parse(saved);
                    document.getElementById('main-nav').classList.remove('hidden');
                    const ud = document.getElementById('user-display'); 
                    ud.classList.remove('hidden'); ud.classList.add('flex');
                    document.getElementById('display-name').innerText = currentUser.name;
                    document.getElementById('display-role').innerText = currentUser.role || 'å­¸å“¡';
                    
                    const role = currentUser.role || '';
                    const isStaff = ['Admin', 'ç®¡ç†å“¡', 'Teacher', 'è€å¸«', 'ç™¼å¸ƒå“¡'].some(r => role.includes(r));
                    const isManagement = ['Admin', 'ç®¡ç†å“¡', 'Teacher', 'è€å¸«', 'Leader', 'çµ„é•·'].some(r => role.includes(r));
                    
                    if (isManagement) document.getElementById('nav-admin').classList.remove('hidden');
                    if (isStaff) {
                        document.getElementById('add-announcement-btn')?.classList.remove('hidden');
                        document.getElementById('nav-img-transfer').classList.remove('hidden');
                    }
                    
                    const dr = document.getElementById('display-role');
                    if(role.includes('Admin') || role.includes('ç®¡ç†å“¡')) dr.className = 'role-badge role-admin';
                    else if(role.includes('Teacher') || role.includes('è€å¸«')) dr.className = 'role-badge role-teacher';
                    else if(role.includes('Leader') || role.includes('çµ„é•·')) dr.className = 'role-badge role-leader';
                    else dr.className = 'role-badge bg-slate-100 text-slate-500';

                    switchView('bulletin');
                } catch(e) { switchView('login'); }
            } else { switchView('login'); }
        }

        function logout() { 
            if(confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) {
                localStorage.removeItem('sh_user_secure'); 
                location.reload(); 
            }
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
